name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '0.0.1'

jobs:
  build:
    name: Build Release
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (remove 'v' prefix)
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Config.swift with secrets
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          # Validate secrets are set
          if [ -z "$GOOGLE_CLIENT_ID" ]; then
            echo "Error: GOOGLE_CLIENT_ID secret is not set"
            exit 1
          fi

          # Generate Config.swift from template with real credentials
          cat > NeverMiss/Sources/Config.swift << 'SWIFT_EOF'
          import Foundation

          struct Config {
              static let googleClientID = "PLACEHOLDER_CLIENT_ID"
              static let googleClientSecret = "PLACEHOLDER_CLIENT_SECRET"

              static var googleRedirectURI: String {
                  return "\(reversedClientID):/oauth2callback"
              }

              static var reversedClientID: String {
                  let parts = googleClientID.components(separatedBy: ".")
                  return parts.reversed().joined(separator: ".")
              }

              static let googleScopes = [
                  "https://www.googleapis.com/auth/calendar.readonly",
                  "https://www.googleapis.com/auth/calendar.events.readonly",
                  "https://www.googleapis.com/auth/userinfo.email",
                  "https://www.googleapis.com/auth/userinfo.profile"
              ]

              static let googleAuthURL = "https://accounts.google.com/o/oauth2/v2/auth"
              static let googleTokenURL = "https://oauth2.googleapis.com/token"
              static let googleUserInfoURL = "https://www.googleapis.com/oauth2/v2/userinfo"
              static let googleCalendarBaseURL = "https://www.googleapis.com/calendar/v3"
              static let bundleIdentifier = "com.nevermiss.app"
          }
          SWIFT_EOF

          # Replace placeholders with actual secrets
          sed -i '' "s|PLACEHOLDER_CLIENT_ID|$GOOGLE_CLIENT_ID|g" NeverMiss/Sources/Config.swift
          sed -i '' "s|PLACEHOLDER_CLIENT_SECRET|$GOOGLE_CLIENT_SECRET|g" NeverMiss/Sources/Config.swift

          echo "Config.swift generated successfully"

      - name: Update version in Info.plist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" NeverMiss/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" NeverMiss/Info.plist
          echo "Updated Info.plist to version $VERSION"

      - name: Build Release
        run: |
          xcodebuild clean build \
            -project NeverMiss.xcodeproj \
            -scheme NeverMiss \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package App
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="build/Build/Products/Release/NeverMiss.app"

          # Verify the app was built
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: App not found at $APP_PATH"
            find build -name "*.app" -type d
            exit 1
          fi

          # Create release directory
          mkdir -p release

          # Create zip archive
          cd build/Build/Products/Release
          zip -r "../../../../release/NeverMiss-$VERSION-macOS.zip" NeverMiss.app
          cd ../../../../

          echo "Created release/NeverMiss-$VERSION-macOS.zip"
          ls -la release/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NeverMiss-${{ steps.version.outputs.version }}
          path: release/NeverMiss-*.zip
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/NeverMiss-*.zip
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
